# ü§ù Contributing to @xcrap/html-parser

Thank you for your interest in contributing! This document provides guidelines and instructions to help you get started.

---

## üìã Table of Contents

- [Code of Conduct](#code-of-conduct)
- [How Can I Contribute?](#how-can-i-contribute)
- [Development Setup](#development-setup)
- [Project Structure](#project-structure)
- [Making Changes](#making-changes)
  - [Branching Strategy](#branching-strategy)
  - [Commit Messages](#commit-messages)
- [Coding Standards](#coding-standards)
  - [Rust](#rust)
  - [TypeScript](#typescript)
- [Writing Tests](#writing-tests)
- [Pull Request Process](#pull-request-process)
- [Reporting Bugs](#reporting-bugs)
- [Requesting Features](#requesting-features)

---

## Code of Conduct

This project and everyone participating in it is expected to follow basic standards of respectful and inclusive communication. Harassment, discrimination, or disrespectful behavior of any kind will not be tolerated.

---

## How Can I Contribute?

There are several ways to contribute to this project:

- üêõ **Report bugs** ‚Äî Open an issue with a clear reproduction case.
- üí° **Suggest features** ‚Äî Open an issue describing the use case and expected behavior.
- üîß **Fix bugs** ‚Äî Check the open issues and submit a pull request.
- ‚ú® **Implement features** ‚Äî Discuss first in an issue before implementing large changes.
- üìñ **Improve documentation** ‚Äî Fix typos, add examples, or clarify existing content.
- üß™ **Write tests** ‚Äî Improve test coverage for edge cases.

---

## Development Setup

### Prerequisites

Ensure you have the following installed:

| Tool       | Minimum Version | Install Link                     |
|------------|-----------------|----------------------------------|
| Rust       | stable          | https://rustup.rs/               |
| Node.js    | >= 18.0.0       | https://nodejs.org/              |
| Yarn       | >= 4.0.0        | `npm install -g yarn`            |

### Installation Steps

```bash
# 1. Fork the repository on GitHub, then clone your fork:
git clone https://github.com/<your-username>/html-parser.git
cd html-parser

# 2. Add the upstream remote:
git remote add upstream https://github.com/Xcrap-Cloud/html-parser.git

# 3. Install Node.js dependencies:
yarn install

# 4. Build the native addon:
yarn build
```

### Verifying Your Setup

```bash
# Run the test suite to confirm everything is working:
yarn test
```

All tests should pass before you begin making changes.

---

## Project Structure

```
@xcrap/html-parser/
‚îú‚îÄ‚îÄ src/                    # Rust source code
‚îÇ   ‚îú‚îÄ‚îÄ lib.rs              # Crate entry point (NAPI export, parse() function)
‚îÇ   ‚îú‚îÄ‚îÄ parser.rs           # HTMLParser struct (lazy-loaded engines)
‚îÇ   ‚îú‚îÄ‚îÄ types.rs            # HTMLElement struct (properties + nested queries)
‚îÇ   ‚îú‚îÄ‚îÄ engines.rs          # Core selection logic (CSS and XPath)
‚îÇ   ‚îî‚îÄ‚îÄ query_builders.rs   # css() and xpath() builder functions
‚îú‚îÄ‚îÄ __test__/
‚îÇ   ‚îî‚îÄ‚îÄ index.spec.ts       # AVA test suite
‚îú‚îÄ‚îÄ benchmark/
‚îÇ   ‚îî‚îÄ‚îÄ bench.ts            # Performance benchmarks
‚îú‚îÄ‚îÄ index.d.ts              # Auto-generated TypeScript declarations (do not edit)
‚îú‚îÄ‚îÄ index.js                # Auto-generated JS entry point (do not edit)
‚îú‚îÄ‚îÄ Cargo.toml              # Rust package manifest
‚îú‚îÄ‚îÄ package.json            # Node.js package manifest
‚îú‚îÄ‚îÄ build.rs                # NAPI build script
‚îî‚îÄ‚îÄ README.md               # Project documentation
```

> ‚ö†Ô∏è Files marked **do not edit** (`index.d.ts`, `index.js`) are auto-generated by `napi build`. They will be overwritten on the next build.

---

## Making Changes

### Branching Strategy

Create a dedicated branch for your contribution:

```bash
# For new features:
git checkout -b feat/your-feature-name

# For bug fixes:
git checkout -b fix/issue-description

# For documentation-only changes:
git checkout -b docs/what-you-changed
```

Always branch off from `main` and keep your branch up-to-date:

```bash
git fetch upstream
git rebase upstream/main
```

### Commit Messages

We follow the [Conventional Commits](https://www.conventionalcommits.org/) specification:

```
<type>(<scope>): <short description>

[optional body]

[optional footer]
```

**Types:**

| Type       | When to use                                                   |
|------------|---------------------------------------------------------------|
| `feat`     | A new feature                                                 |
| `fix`      | A bug fix                                                     |
| `docs`     | Documentation-only changes                                    |
| `refactor` | Code changes that don't fix a bug or add a feature           |
| `test`     | Adding or correcting tests                                    |
| `chore`    | Tooling, config, dependency updates                           |
| `perf`     | A code change that improves performance                       |

**Examples:**

```bash
git commit -m "feat: add support for data-* attribute queries"
git commit -m "fix: handle empty id attribute in HTMLElement.id getter"
git commit -m "docs: add XPath query examples to README"
git commit -m "test: add edge case for invalid CSS selector"
```

---

## Coding Standards

### Rust

- Follow the [Rust API Guidelines](https://rust-lang.github.io/api-guidelines/).
- Run `cargo fmt` (or `yarn format:rs`) before committing.
- Run `cargo clippy` and address any warnings ‚Äî the crate has `#![deny(clippy::all)]`.
- Prefer `Option` over panics for recoverable failure modes (e.g., element not found).
- Document public functions with `///` doc comments.

```rust
/// Selects the first element matching `query` using the CSS engine.
///
/// Returns `None` if no element matches or the query is invalid.
pub fn select_first_by_css(document: &Html, query: String) -> Option<HTMLElement> {
    // ...
}
```

### TypeScript

- Follow the existing code style enforced by **Prettier** and **OXLint**.
- Run `yarn format:prettier` and `yarn lint` before committing.
- Avoid `any` ‚Äî use explicit types or generics.
- Do not manually edit `index.d.ts` or `index.js` ‚Äî they are auto-generated.

---

## Writing Tests

Tests live in `__test__/index.spec.ts` and are run with [AVA](https://github.com/avajs/ava).

**Guidelines:**

1. Each test should cover a **single behavior**.
2. Use descriptive test titles: `"HTMLElement.id returns null when element has no id"`.
3. Group related tests with section comments (e.g., `// ‚îÄ‚îÄ‚îÄ HTMLElement ‚Äî properties ‚îÄ‚îÄ‚îÄ`).
4. When fixing a bug, add a test that **would have failed** before the fix.
5. Cover edge cases: empty strings, missing attributes, invalid selectors, `null` returns.

**Example:**

```ts
test("HTMLElement.getAttribute returns null for a missing attribute", (t) => {
  const parser = new HTMLParser("<div>Hello</div>")
  const el = parser.selectFirst({ query: css("div") }) as HTMLElement
  t.is(el.getAttribute("data-missing"), null)
})
```

**Running tests:**

```bash
yarn test
```

---

## Pull Request Process

1. **Ensure all checks pass** ‚Äî tests, formatting, and linting.
2. **Update documentation** ‚Äî if your change affects the public API, update `README.md`.
3. **Keep the PR focused** ‚Äî one feature or fix per PR. Avoid bundling unrelated changes.
4. **Fill in the PR template** ‚Äî describe what changed and why, and link to related issues.
5. **Be responsive** ‚Äî address review comments promptly.

PRs are reviewed by maintainers. We aim to provide feedback within a few days.

---

## Reporting Bugs

Before opening a bug report:
- Check the [existing issues](https://github.com/Xcrap-Cloud/html-parser/issues) to avoid duplicates.
- Confirm the bug is reproducible on a supported Node.js version (>= 18).

When opening an issue, include:
- A **minimal reproduction** (HTML snippet + code that triggers the bug).
- The **expected** vs. **actual** behavior.
- Your **environment**: OS, Node.js version, package version.

---

## Requesting Features

Open an issue labeled `enhancement` with:
- A clear description of the problem you're trying to solve.
- The proposed API or behavior (with examples if possible).
- Any alternatives you've considered.

Large features should be discussed in an issue **before** implementation to avoid wasted effort.

---

Thank you for contributing! üéâ
